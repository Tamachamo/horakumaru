<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>釣り船 豊楽丸 | 釣れてる感、毎日更新。</title>
  <meta name="description" content="釣果が一目でわかる。最新の釣果・月別の数字をトップに自動表示。ご予約は予約ページへ。" />
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React (CDN) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;600;700;900&display=swap" rel="stylesheet">
  <style>
    html, body { font-family: 'Noto Sans JP', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif; }
    .glass { backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
    select option { background: #0b1220; color: #fff; }
  </style>
</head>

<body class="min-h-screen bg-gradient-to-b from-slate-950 via-slate-900 to-black text-white">
  <div id="root"></div>

  <script type="text/babel">
    // === 設定（あなたのGAS WebアプリURLに置き換え） ===
    const DATA_API_URL = "https://script.google.com/macros/s/AKfycbzKb9zzt51SdRH9PiF5uDEj9pnz58st2PjO_oxG7Z3Gb_XDIWqYsvqbxqFqfkSEN0Ol/exec";
    const SITE = {
      name: "釣り船 豊楽丸",
      tel: "070-7584-2076",
      bookingUrl: "./booking.html",
      heroCatch: "釣れてる感、月別で刺す。",
      heroSub: "当月がデフォ。年/月を選べば、その月の釣果だけを表示。数字もギャラリーも連動。"
    };

    // ---- utils ----
    function pad2(n){ return String(n).padStart(2,"0"); }
    function toMonthKey(dateStr){
      if(!dateStr) return "";
      return String(dateStr).slice(0,7); // yyyy-MM
    }
    function getNowYMJST(){
      const now = new Date();
      return { y: now.getFullYear(), m: now.getMonth()+1 };
    }

    function countUp(el, to, duration=900) {
      const from = 0;
      const start = performance.now();
      const step = (t) => {
        const p = Math.min(1, (t - start) / duration);
        const v = Math.floor(from + (to - from) * (1 - Math.pow(1-p, 3)));
        el.textContent = String(v);
        if (p < 1) requestAnimationFrame(step);
      };
      requestAnimationFrame(step);
    }

    function useSheetData() {
      const [state, setState] = React.useState({ loading: true, error: null, data: null });

      React.useEffect(() => {
        let cancelled = false;

        const load = () => {
          fetch(DATA_API_URL, { cache: "no-store" })
            .then(r => r.json())
            .then(json => {
              if (cancelled) return;
              setState({ loading: false, error: null, data: json });
            })
            .catch(e => {
              if (cancelled) return;
              setState({ loading: false, error: String(e), data: null });
            });
        };

        load();
        const t = setInterval(load, 60000); // 1分ごと更新（“最新感”）
        return () => { cancelled = true; clearInterval(t); };
      }, []);

      return state;
    }

    function computeMonthStats(results){
      const rows = results || [];
      const sum = (k)=> rows.reduce((a,r)=> a + (Number(r?.[k])||0), 0);
      const max = (k)=> rows.reduce((m,r)=> Math.max(m, (Number(r?.[k])||0)), 0);
      return {
        month_fish_total: sum("count"),
        month_max_cm: max("max_cm"),
        month_rows: rows.length,
        month_fish_types: new Set(rows.map(r=>r.fish).filter(Boolean)).size
      };
    }

    function formatYMLabel(y, m){
      return `${y}年${m}月`;
    }

    // ---- UI parts ----
    function StatCard({id, label, unit}) {
      return (
        <div className="rounded-2xl bg-white/10 ring-1 ring-white/15 p-4 text-center">
          <div className="text-3xl font-black">
            <span id={id}>0</span>{unit ? <span className="ml-1 text-xl font-extrabold">{unit}</span> : null}
          </div>
          <div className="text-xs text-white/80 mt-1">{label}</div>
        </div>
      );
    }

    function Stats({ label, stats }) {
      const monthFish = Number(stats?.month_fish_total || 0);
      const monthMax  = Number(stats?.month_max_cm || 0);
      const monthRows = Number(stats?.month_rows || 0);
      const monthTypes= Number(stats?.month_fish_types || 0);

      React.useEffect(() => {
        const a = document.getElementById("stat-month-fish");
        const b = document.getElementById("stat-month-max");
        const c = document.getElementById("stat-month-rows");
        const d = document.getElementById("stat-month-types");
        if (a) countUp(a, monthFish);
        if (b) countUp(b, monthMax);
        if (c) countUp(c, monthRows);
        if (d) countUp(d, monthTypes);
      }, [monthFish, monthMax, monthRows, monthTypes]);

      return (
        <div className="mt-8">
          <div className="text-sm text-white/80">集計（{label}）</div>
          <div className="mt-3 grid grid-cols-2 md:grid-cols-4 gap-3">
            <StatCard id="stat-month-fish" label="月合計" unit="尾" />
            <StatCard id="stat-month-max" label="月最大サイズ" unit="cm" />
            <StatCard id="stat-month-rows" label="釣果件数" unit="" />
            <StatCard id="stat-month-types" label="魚種数" unit="" />
          </div>
        </div>
      );
    }

function Gallery({ results, onOpen }) {
  const items = (results || [])
    .filter(r => r.photo_url)   // 画像未設定は完全に表示しない
    .slice(0, 16);

  if (items.length === 0) return null;

  return (
    <div className="mt-8 grid grid-cols-2 md:grid-cols-4 gap-4">
      {items.map((r, i) => {
        const src = r.photo_url; // GAS側でthumbnail形式にしてある前提
        const dateText = r.date || ""; // yyyy-mm-dd のまま表示

        const cap = [r.date, r.fish, r.count ? (r.count + "杯/匹") : "", r.max_cm ? (r.max_cm + "cm") : ""]
          .filter(Boolean)
          .join(" / ");

        return (
          <button
            key={i}
            type="button"
            onClick={() => onOpen?.(src, dateText)}
            className="relative overflow-hidden rounded-xl ring-1 ring-white/10 bg-white/5 group focus:outline-none"
            aria-label={cap || "釣果写真を拡大表示"}
          >
            <img
              src={src}
              alt={cap}
              loading="lazy"
              className="aspect-square w-full object-cover transition-transform duration-300 group-hover:scale-105"
            />

            {/* hover overlay */}
            <span className="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition"></span>

            {/* date badge (yyyy-mm-dd) */}
            {dateText ? (
              <span className="absolute bottom-2 left-2 rounded-md bg-black/70 px-2 py-0.5 text-[11px] font-semibold text-white">
                {dateText}
              </span>
            ) : null}
          </button>
        );
      })}
    </div>
  );
}



    function ResultsList({results}) {
      const items = (results || []).slice(0, 10);
      return (
        <div className="mt-6 rounded-2xl bg-white/5 ring-1 ring-white/10 overflow-hidden">
          <div className="px-5 py-3 border-b border-white/10 font-bold">この月の直近釣果</div>
          <div className="divide-y divide-white/10">
            {items.map((r, i) => (
              <div key={i} className="px-5 py-3 flex items-start justify-between gap-4">
                <div>
                  <div className="font-semibold">{r.fish || "—"} <span className="text-white/70 text-sm ml-2">{r.date || ""}</span></div>
                  <div className="text-sm text-white/75 mt-0.5">{r.note || ""}</div>
                </div>
                <div className="text-right whitespace-nowrap">
                  <div className="font-extrabold">{r.count ? `${r.count}杯/匹` : "—"}</div>
                  <div className="text-sm text-white/70">{r.max_cm ? `${r.max_cm}cm` : ""}</div>
                </div>
              </div>
            ))}
            {items.length === 0 ? (
              <div className="px-5 py-6 text-white/70 text-sm">この月のデータがありません。</div>
            ) : null}
          </div>
        </div>
      );
    }

    function MonthPicker({ years, year, month, onYear, onMonth }) {
      const monthOptions = Array.from({length: 12}, (_,i)=> i+1);

      return (
        <div className="mt-6 flex flex-col md:flex-row md:items-end gap-3 md:gap-4">
          <div className="flex-1">
            <div className="text-sm font-semibold text-white/90">表示月</div>

            <div className="mt-2 flex flex-col sm:flex-row gap-2">
              <div className="flex gap-2">
                <select
                  className="w-full sm:w-40 rounded-xl bg-white/10 ring-1 ring-white/20 px-3 py-2 text-sm outline-none"
                  value={year}
                  onChange={(e)=> onYear(Number(e.target.value))}
                >
                  {years.map(y => <option key={y} value={y}>{y}年</option>)}
                </select>

                <select
                  className="w-full sm:w-32 rounded-xl bg-white/10 ring-1 ring-white/20 px-3 py-2 text-sm outline-none"
                  value={month}
                  onChange={(e)=> onMonth(Number(e.target.value))}
                >
                  {monthOptions.map(m => <option key={m} value={m}>{m}月</option>)}
                </select>
              </div>

              <a
                href={SITE.bookingUrl}
                className="hidden md:inline-flex items-center justify-center rounded-xl bg-sky-500 hover:bg-sky-400 px-5 py-2 font-semibold"
              >
                予約へ
              </a>
            </div>

            <div className="mt-2 text-xs text-white/70">
              ※デフォは当月（JST）。年/月を変えると、その月の釣果だけ表示されます。
            </div>
          </div>
        </div>
      );
    }

    function App() {
      const telHref = "tel:" + SITE.tel.replace(/[^0-9+]/g, "");
      const sheet = useSheetData();
      const updatedText = sheet.data ? ("最終更新: " + sheet.data.updated_at) : "";
      const [lightboxSrc, setLightboxSrc] = React.useState(null);

      const allResults = sheet.data ? sheet.data.results : [];

      const years = React.useMemo(() => {
        const set = new Set((allResults||[]).map(r => {
          const mk = toMonthKey(r.date);
          if (!mk) return null;
          return Number(mk.slice(0,4));
        }).filter(Boolean));
        const arr = Array.from(set).sort((a,b)=> b-a);
        if (arr.length === 0) {
          const now = getNowYMJST();
          return [now.y];
        }
        return arr;
      }, [sheet.data]);

      const now = getNowYMJST();
      const [selectedYear, setSelectedYear] = React.useState(now.y);
      const [selectedMonth, setSelectedMonth] = React.useState(now.m);

      React.useEffect(() => {
        if (!allResults || allResults.length === 0) return;

        const latestKey = toMonthKey(allResults[0]?.date);
        if (!latestKey) return;

        const currentKey = `${now.y}-${pad2(now.m)}`;
        const hasCurrent = allResults.some(r => toMonthKey(r.date) === currentKey);

        if (hasCurrent) {
          setSelectedYear(now.y);
          setSelectedMonth(now.m);
          return;
        }

        const ly = Number(latestKey.slice(0,4));
        const lm = Number(latestKey.slice(5,7));
        setSelectedYear(ly);
        setSelectedMonth(lm);
        // eslint-disable-next-line react-hooks/exhaustive-deps
      }, [sheet.data]);

      const selectedKey = React.useMemo(() => `${selectedYear}-${pad2(selectedMonth)}`, [selectedYear, selectedMonth]);

      const filteredResults = React.useMemo(() => {
        return (allResults||[]).filter(r => toMonthKey(r.date) === selectedKey);
      }, [allResults, selectedKey]);

      const selectedStats = React.useMemo(() => computeMonthStats(filteredResults), [filteredResults]);
      const label = React.useMemo(() => formatYMLabel(selectedYear, selectedMonth), [selectedYear, selectedMonth]);

      return (
        <main>
          <header className="sticky top-0 z-40 border-b border-white/10 glass bg-slate-950/60">
            <nav className="mx-auto max-w-7xl px-4 md:px-8 py-3 flex items-center justify-between">
              <a href="#" className="flex items-center gap-2 font-extrabold tracking-wide">
                <span className="inline-block h-5 w-5 rounded-full bg-sky-400"></span>{SITE.name}
              </a>
              <div className="flex items-center gap-2">
                <a href="#results" className="text-sm text-white/80 hover:text-sky-200">釣果</a>
                <a href={SITE.bookingUrl} className="text-sm px-4 py-2 rounded-full bg-sky-500 hover:bg-sky-400 font-semibold">今すぐ予約</a>
              </div>
            </nav>
          </header>

          <section className="mx-auto max-w-7xl px-4 md:px-8 pt-10 md:pt-14">
            <div className="rounded-3xl overflow-hidden ring-1 ring-white/10 bg-gradient-to-br from-slate-900/60 to-black/40">
              <div className="p-7 md:p-10">
                <div className="inline-flex items-center gap-2 rounded-full bg-white/10 px-3 py-1 text-xs tracking-widest text-white/80 ring-1 ring-white/20">
                  FISHING REPORT
                </div>
                <h1 className="mt-4 text-3xl md:text-5xl font-black leading-tight drop-shadow">
                  {SITE.heroCatch}
                </h1>
                <p className="mt-3 text-white/80 max-w-2xl">
                  {SITE.heroSub}
                </p>

                {updatedText ? (
                  <div className="mt-4 text-xs text-white/70">{updatedText}</div>
                ) : null}

                <div className="mt-6 flex flex-col sm:flex-row gap-3">
                  <a href={SITE.bookingUrl} className="inline-flex items-center justify-center rounded-full bg-sky-500 hover:bg-sky-400 px-6 py-3 font-semibold">
                    予約ページへ
                  </a>
                  <a href={telHref} className="inline-flex items-center justify-center rounded-full bg-white/10 hover:bg-white/15 ring-1 ring-white/20 px-6 py-3 font-semibold">
                    電話する（{SITE.tel}）
                  </a>
                </div>

                <MonthPicker
                  years={years}
                  year={selectedYear}
                  month={selectedMonth}
                  onYear={setSelectedYear}
                  onMonth={setSelectedMonth}
                />

                <Stats label={label} stats={selectedStats} />
              </div>
            </div>

            {sheet.loading ? (
              <div className="mt-6 text-white/70 text-sm">データ読み込み中…（GAS URLが未設定だとここで止まる）</div>
            ) : sheet.error ? (
              <div className="mt-6 text-red-200 text-sm">データ取得エラー: {sheet.error}</div>
            ) : null}
          </section>

          <section id="results" className="mx-auto max-w-7xl px-4 md:px-8 py-10 md:py-14">
            <div className="flex items-end justify-between gap-4">
              <div>
                <h2 className="text-2xl md:text-3xl font-extrabold">釣果ギャラリー</h2>
                <p className="mt-2 text-white/75">{label} の釣果だけ表示中。写真が増えるほど「釣れてる感」は増幅。</p>
              </div>
              <a href={SITE.bookingUrl} className="hidden md:inline-flex items-center justify-center rounded-full bg-white/10 hover:bg-white/15 ring-1 ring-white/20 px-5 py-2.5 font-semibold">
                予約へ
              </a>
            </div>

            <Gallery
              results={filteredResults}
              onOpen={(src) => setLightboxSrc(src)}
              />

            <ResultsList results={filteredResults} />
          </section>

          <footer className="border-t border-white/10 py-10 text-center text-white/70 text-sm">
            <p>© {new Date().getFullYear()} {SITE.name}</p>
          </footer>
          {lightboxSrc && (
          <div
            className="fixed inset-0 z-50 bg-black/90 flex items-center justify-center"
            onClick={() => setLightboxSrc(null)}
            >
         <img
           src={lightboxSrc}
           className="max-w-[95vw] max-h-[95vh] object-contain"
           alt=""
           />
          </div>
        )}
        </main>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
