<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>釣り船 豊楽丸 | 釣れてる感、毎日更新。</title>
  <meta name="description" content="釣果が一目でわかる。最新の釣果・今日/今月の数字をトップに自動表示。ご予約は予約ページへ。" />
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React (CDN) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;600;700;900&display=swap" rel="stylesheet">
  <style>
    html, body { font-family: 'Noto Sans JP', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif; }
    .glass { backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
  </style>
</head>

<body class="min-h-screen bg-gradient-to-b from-slate-950 via-slate-900 to-black text-white">
  <div id="root"></div>

  <script type="text/babel">
    // === 設定（あなたのGAS WebアプリURLに置き換え） ===
    const DATA_API_URL = "https://script.google.com/macros/s/AKfycbyDI-0p_ah3NonEI3d1cTV_Mrmt7OqBH52nT7X94B7nIk0THqM3zKWFGkF1BsjOHriC/exec";

    const SITE = {
      name: "釣り船 豊楽丸",
      tel: "070-7584-2076",
      bookingUrl: "./booking.html",
      heroCatch: "釣れてる感、毎日更新。",
      heroSub: "今日の釣果 / 今月の累計 / 直近の写真。数字と実写で、嘘つかないトップへ。"
    };

    function countUp(el, to, duration=900) {
      const from = 0;
      const start = performance.now();
      const step = (t) => {
        const p = Math.min(1, (t - start) / duration);
        const v = Math.floor(from + (to - from) * (1 - Math.pow(1-p, 3)));
        el.textContent = String(v);
        if (p < 1) requestAnimationFrame(step);
      };
      requestAnimationFrame(step);
    }

    function useSheetData() {
      const [state, setState] = React.useState({ loading: true, error: null, data: null });

      React.useEffect(() => {
        let cancelled = false;

        const load = () => {
          fetch(DATA_API_URL, { cache: "no-store" })
            .then(r => r.json())
            .then(json => {
              if (cancelled) return;
              setState({ loading: false, error: null, data: json });
            })
            .catch(e => {
              if (cancelled) return;
              setState({ loading: false, error: String(e), data: null });
            });
        };

        load();
        const t = setInterval(load, 60000); // 1分ごと更新（“最新感”）
        return () => { cancelled = true; clearInterval(t); };
      }, []);

      return state;
    }

    function StatCard({id, label, unit}) {
      return (
        <div className="rounded-2xl bg-white/10 ring-1 ring-white/15 p-4 text-center">
          <div className="text-3xl font-black">
            <span id={id}>0</span>{unit ? <span className="ml-1 text-xl font-extrabold">{unit}</span> : null}
          </div>
          <div className="text-xs text-white/80 mt-1">{label}</div>
        </div>
      );
    }

    function Stats({stats}) {
      const todayFish = Number(stats?.today_fish_total || 0);
      const todayMax  = Number(stats?.today_max_cm || 0);
      const todayGroups = Number(stats?.today_groups || 0);
      const monthFish = Number(stats?.month_fish_total || 0);

      React.useEffect(() => {
        const a = document.getElementById("stat-today-fish");
        const b = document.getElementById("stat-today-big");
        const c = document.getElementById("stat-today-groups");
        const d = document.getElementById("stat-month-fish");
        if (a) countUp(a, todayFish);
        if (b) countUp(b, todayMax);
        if (c) countUp(c, todayGroups);
        if (d) countUp(d, monthFish);
      }, [todayFish, todayMax, todayGroups, monthFish]);

      return (
        <div className="mt-10 grid grid-cols-2 md:grid-cols-4 gap-3">
          <StatCard id="stat-today-fish" label="今日のトータル" unit="尾" />
          <StatCard id="stat-today-big" label="本日の最大サイズ" unit="cm" />
          <StatCard id="stat-today-groups" label="本日の便数" unit="" />
          <StatCard id="stat-month-fish" label="今月累計" unit="尾" />
        </div>
      );
    }

    function Gallery({results}) {
      const items = (results || []).slice(0, 16);
      return (
        <div className="mt-8 grid grid-cols-2 md:grid-cols-4 gap-4">
          {items.map((r, i) => {
            const src = r.photo_url || "";
            const cap = [r.date, r.fish, r.count ? (r.count + "杯/匹") : "", r.max_cm ? (r.max_cm + "cm") : ""]
              .filter(Boolean).join(" / ");

            return (
              <figure key={i} className="relative overflow-hidden rounded-xl ring-1 ring-white/10 group bg-white/5">
                {src ? (
                  <img src={src} alt={cap} className="aspect-square w-full object-cover transition-transform duration-500 group-hover:scale-105" />
                ) : (
                  <div className="aspect-square w-full grid place-items-center text-white/60 text-sm">
                    photo_url未設定
                  </div>
                )}
                <figcaption className="absolute bottom-0 left-0 right-0 px-2 py-1 text-[11px] bg-gradient-to-t from-black/70 to-transparent">
                  {cap}
                </figcaption>
              </figure>
            );
          })}
        </div>
      );
    }

    function ResultsList({results}) {
      const items = (results || []).slice(0, 10);
      return (
        <div className="mt-6 rounded-2xl bg-white/5 ring-1 ring-white/10 overflow-hidden">
          <div className="px-5 py-3 border-b border-white/10 font-bold">直近の釣果</div>
          <div className="divide-y divide-white/10">
            {items.map((r, i) => (
              <div key={i} className="px-5 py-3 flex items-start justify-between gap-4">
                <div>
                  <div className="font-semibold">{r.fish || "—"} <span className="text-white/70 text-sm ml-2">{r.date || ""}</span></div>
                  <div className="text-sm text-white/75 mt-0.5">{r.note || ""}</div>
                </div>
                <div className="text-right whitespace-nowrap">
                  <div className="font-extrabold">{r.count ? `${r.count}杯/匹` : "—"}</div>
                  <div className="text-sm text-white/70">{r.max_cm ? `${r.max_cm}cm` : ""}</div>
                </div>
              </div>
            ))}
          </div>
        </div>
      );
    }

    function App() {
      const telHref = "tel:" + SITE.tel.replace(/[^0-9+]/g, "");
      const sheet = useSheetData();
      const updatedText = sheet.data ? ("最終更新: " + sheet.data.updated_at) : "";

      return (
        <main>
          {/* Header */}
          <header className="sticky top-0 z-40 border-b border-white/10 glass bg-slate-950/60">
            <nav className="mx-auto max-w-7xl px-4 md:px-8 py-3 flex items-center justify-between">
              <a href="#" className="flex items-center gap-2 font-extrabold tracking-wide">
                <span className="inline-block h-5 w-5 rounded-full bg-sky-400"></span>{SITE.name}
              </a>
              <div className="flex items-center gap-2">
                <a href="#results" className="text-sm text-white/80 hover:text-sky-200">釣果</a>
                <a href={SITE.bookingUrl} className="text-sm px-4 py-2 rounded-full bg-sky-500 hover:bg-sky-400 font-semibold">今すぐ予約</a>
              </div>
            </nav>
          </header>

          {/* Hero */}
          <section className="mx-auto max-w-7xl px-4 md:px-8 pt-10 md:pt-14">
            <div className="rounded-3xl overflow-hidden ring-1 ring-white/10 bg-gradient-to-br from-slate-900/60 to-black/40">
              <div className="p-7 md:p-10">
                <div className="inline-flex items-center gap-2 rounded-full bg-white/10 px-3 py-1 text-xs tracking-widest text-white/80 ring-1 ring-white/20">
                  FISHING REPORT
                </div>
                <h1 className="mt-4 text-3xl md:text-5xl font-black leading-tight drop-shadow">
                  {SITE.heroCatch}
                </h1>
                <p className="mt-3 text-white/80 max-w-2xl">
                  {SITE.heroSub}
                </p>

                {updatedText ? (
                  <div className="mt-4 text-xs text-white/70">{updatedText}</div>
                ) : null}

                <div className="mt-6 flex flex-col sm:flex-row gap-3">
                  <a href={SITE.bookingUrl} className="inline-flex items-center justify-center rounded-full bg-sky-500 hover:bg-sky-400 px-6 py-3 font-semibold">
                    予約ページへ
                  </a>
                  <a href={telHref} className="inline-flex items-center justify-center rounded-full bg-white/10 hover:bg-white/15 ring-1 ring-white/20 px-6 py-3 font-semibold">
                    電話する（{SITE.tel}）
                  </a>
                </div>

                {/* Stats */}
                <Stats stats={sheet.data ? sheet.data.stats : null} />
              </div>
            </div>

            {/* Error/Loading */}
            {sheet.loading ? (
              <div className="mt-6 text-white/70 text-sm">データ読み込み中…（GAS URLが未設定だとここで止まる）</div>
            ) : sheet.error ? (
              <div className="mt-6 text-red-200 text-sm">データ取得エラー: {sheet.error}</div>
            ) : null}
          </section>

          {/* Results */}
          <section id="results" className="mx-auto max-w-7xl px-4 md:px-8 py-10 md:py-14">
            <div className="flex items-end justify-between gap-4">
              <div>
                <h2 className="text-2xl md:text-3xl font-extrabold">釣果ギャラリー</h2>
                <p className="mt-2 text-white/75">写真が増えるほど「釣れてる感」は増幅。ここがLPの心臓。</p>
              </div>
              <a href={SITE.bookingUrl} className="hidden md:inline-flex items-center justify-center rounded-full bg-white/10 hover:bg-white/15 ring-1 ring-white/20 px-5 py-2.5 font-semibold">
                予約へ
              </a>
            </div>

            <Gallery results={sheet.data ? sheet.data.results : []} />
            <ResultsList results={sheet.data ? sheet.data.results : []} />
          </section>

          {/* Footer */}
          <footer className="border-t border-white/10 py-10 text-center text-white/70 text-sm">
            <p>© {new Date().getFullYear()} {SITE.name}</p>
          </footer>
        </main>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
